{
  "title": "-tests_test_logger.py",
  "text": "## [[Tags]]\nPython -tests_test_logger.py -src_logger.py [[--- Codigo]] [[--ðŸ§ª tests/]]\n\n```python\n# tests/test_logger.py\n\nimport sys\nfrom pathlib import Path\n\n# ðŸ”§ Asegura que src/ sea visible desde cualquier entorno\nsys.path.append(str(Path(__file__).resolve().parents[1]))\n\nimport os\nimport json\nimport pytest\n\nfrom src.logger import log_evento, log_validacion  # <- ya podÃ©s importar ambos\n\n\n# ðŸŒ Forzar idioma en pruebas\nos.environ[\"LANG\"] = \"es\"\n\n@pytest.fixture\ndef ruta_dummy(tmp_path):\n    archivo = tmp_path / \"demo_test.pdf\"\n    archivo.write_text(\"Contenido simulado para logging.\")\n    return str(archivo)\n\ndef test_log_evento_clasificado_en_consola_y_jsonl(ruta_dummy):\n    mensaje = log_evento(\"clasificado\", archivo=ruta_dummy, categoria=\"Ciencias\", dewey=\"500\")\n    assert \"ðŸ“– Clasificado como: Ciencias (500)\" in mensaje\n\n    # âœ… Persistencia .jsonl\n    logs_dir = Path(\"output/logs\")\n    jsonl_logs = list(logs_dir.glob(\"run_*.jsonl\"))\n    assert jsonl_logs, \"No se generÃ³ archivo .jsonl\"\n\n    eventos = []\n    with open(jsonl_logs[-1], encoding=\"utf-8\") as f:\n        for line in f:\n            try:\n                data = json.loads(line)\n                if data.get(\"evento\") == \"clasificado\":\n                    eventos.append(data)\n            except json.JSONDecodeError:\n                continue  # LÃ­nea corrupta o mal formada\n\n    assert eventos, \"No se encontrÃ³ el evento 'clasificado'\"\n    assert eventos[-1][\"categoria\"] == \"Ciencias\"\n    assert eventos[-1][\"dewey\"] == \"500\"\n    assert eventos[-1][\"nivel\"] == \"INFO\"\n\n\n\ndef test_log_warning_texto_corto(ruta_dummy):\n    mensaje = log_evento(\"warning_texto_corto\", archivo=ruta_dummy, nivel=\"WARNING\")\n    assert \"âš ï¸ Texto extraÃ­do demasiado corto\" in mensaje\n\ndef test_log_error_parse(ruta_dummy):\n    mensaje = log_evento(\"error_parse\", archivo=ruta_dummy, nivel=\"ERROR\")\n    assert \"âŒ Error procesando archivo\" in mensaje\n\ndef test_log_individual_por_pdf(ruta_dummy):\n    log_evento(\"procesar\", archivo=ruta_dummy)\n\n    logs_dir = Path(\"output/logs\")\n    nombre_pdf = Path(ruta_dummy).stem\n    archivo_log = logs_dir / f\"{nombre_pdf}.log\"\n\n    assert archivo_log.exists(), f\"No se creÃ³ log individual: {archivo_log}\"\n\n    with open(archivo_log, encoding=\"utf-8\") as f:\n        contenido = f.read()\n        assert \"ðŸ“˜\" in contenido or \"PROCESAR\" in contenido.upper()\n\ndef test_log_validacion_crea_log_por_hash(tmp_path):\n    # Simula un PDF hash ficticio\n    hash_doc = \"abc123hash\"\n\n    ruta = tmp_path / \"doc_ejemplo.pdf\"\n    ruta.write_text(\"Contenido del documento para test\")\n\n    # Registro semÃ¡ntico\n    log_validacion(\n        evento=\"validation_error\",\n        error_code=\"E4002\",\n        severity=\"WARNING\",\n        zone=\"abstract\",\n        archivo=str(ruta),\n        razones=[\"Resumen fuera de rango: 87 palabras.\"],\n        hash=hash_doc\n    )\n\n    # Verifica log por hash\n    log_hash_file = Path(\"output/logs\") / f\"{hash_doc}.jsonl\"\n    assert log_hash_file.exists(), \"No se creÃ³ el log por hash\"\n\n    with open(log_hash_file, encoding=\"utf-8\") as f:\n        data = json.loads(f.readline())\n        assert data[\"error_code\"] == \"E4002\"\n        assert data[\"zone\"] == \"abstract\"\n        assert data[\"severity\"] == \"WARNING\"\n        assert \"Resumen fuera de rango\" in data[\"razones\"][0]\n\n```",
  "tags": "Python -tests_test_logger.py -src_logger.py [[--- Codigo]] [[--ðŸ§ª tests/]]",
  "type": "text/markdown",
  "created": "20250424175932293",
  "modified": "20250424175932293"
}